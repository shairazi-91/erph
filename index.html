<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e-RPH Sains SMK Datuk Patinggi Kedit</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <!-- LINK KE FAIL DATA (PENTING) -->
    <script src="data.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* PDF Preview Hidden */
        #pdf-preview-section {
            display: none;
            background: white;
            width: 210mm; min-height: 297mm;
            margin: 0 auto; padding: 15mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* Generating Mode */
        body.generating-mode #main-form, body.generating-mode nav, body.generating-mode #floating-ai-btn { display: none; }
        body.generating-mode #pdf-preview-section { display: block; }
        body.generating-mode { background-color: white; }

        /* Table & Layout */
        .official-table {
            width: 100%; border-collapse: collapse; border: 1px solid #000;
            font-family: 'Times New Roman', Times, serif; font-size: 11pt; color: #000;
        }
        .official-table td { border: 1px solid #000; padding: 5px 8px; vertical-align: top; line-height: 1.2; }
        .bg-gray-official { background-color: #e5e7eb; font-weight: bold; width: 20%; }
        .text-content { white-space: pre-wrap; text-align: justify; }
        .refleksi-line { border-bottom: 1px solid #000; height: 25px; margin-top: 5px; }

        /* AI Button */
        #floating-ai-btn { position: fixed; bottom: 30px; right: 30px; z-index: 50; animation: bounce 2s infinite; }
        #ai-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; z-index: 60; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border-radius: 1rem; border: 2px solid #3b82f6; }
        #ai-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 55; backdrop-filter: blur(2px); }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body class="text-gray-800">

    <nav class="bg-blue-900 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img src="https://i.postimg.cc/15tfw5q1/logo-kedit.avif" alt="Logo" class="h-12 w-auto bg-white rounded-full p-0.5">
                <div>
                    <h1 class="text-lg font-bold leading-tight uppercase">Sistem e-RPH Sains</h1>
                    <p class="text-xs text-blue-200 uppercase">SMK Datuk Patinggi Kedit</p>
                </div>
            </div>
            <span class="text-xs bg-blue-800 px-3 py-1 rounded-full hidden sm:inline-block">DSKP KSSM + AI</span>
        </div>
    </nav>

    <main id="main-form" class="max-w-4xl mx-auto px-4 py-8 pb-20">
        <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-700">Butiran RPH</h2>
            </div>
            <div class="p-6 space-y-6">
                <!-- Inputs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Mata Pelajaran / Subject</label>
                        <input type="text" id="inp_subject" value="Sains / Science" class="w-full px-4 py-2 bg-gray-100 border rounded-lg" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Kelas / Class</label>
                        <input type="text" id="inp_kelas" placeholder="Contoh: 5 Sains 1" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Tarikh / Date</label>
                        <input type="date" id="inp_tarikh" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Masa / Time</label>
                        <input type="text" id="inp_masa" placeholder="8.00 - 9.00 AM" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <hr>
                
                <!-- DSKP Selectors -->
                <div class="bg-blue-50 p-5 rounded-lg border border-blue-100 space-y-4">
                    <h3 class="font-bold text-blue-800 text-sm uppercase">Pilihan DSKP</h3>
                    <div>
                        <label class="block text-sm font-bold text-gray-700">1. Pilih Tingkatan / Form</label>
                        <select id="sel_tingkatan" onchange="updateBab()" class="w-full px-4 py-2 border border-blue-500 rounded-lg bg-white">
                            <option value="">-- Pilih / Select --</option>
                            <option value="Tingkatan 2 (DLP)">Tingkatan 2 (DLP - English)</option>
                            <option value="Tingkatan 3 (DLP)">Tingkatan 3 (DLP - English)</option>
                            <option value="Tingkatan 5">Tingkatan 5 (BM)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700">2. Bab / Theme</label>
                        <select id="sel_bab" onchange="updateSK()" class="w-full px-4 py-2 border rounded-lg bg-white" disabled><option value="">-- Select Form First --</option></select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700">3. Standard Kandungan / Content Standard</label>
                        <select id="sel_sk" onchange="updateSP()" class="w-full px-4 py-2 border rounded-lg bg-white" disabled><option value="">-- Select Theme First --</option></select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700">4. Standard Pembelajaran / Learning Standard</label>
                        <select id="sel_sp" onchange="addSP()" class="w-full px-4 py-2 border rounded-lg bg-white" disabled><option value="">-- Select CS First --</option></select>
                    </div>
                </div>

                <!-- Textareas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Standard Kandungan</label>
                        <textarea id="txt_sk" rows="3" class="w-full px-4 py-2 bg-gray-50 border rounded-lg" readonly></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Standard Pembelajaran</label>
                        <textarea id="txt_sp" rows="5" class="w-full px-4 py-2 border rounded-lg" placeholder="Dipilih dari dropdown..."></textarea>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 flex justify-between items-center mb-1">
                        Objektif / Objectives
                        <span class="text-xs text-blue-600 cursor-pointer bg-blue-100 px-2 py-1 rounded hover:bg-blue-200" onclick="openAIModal('obj')"><i class="fas fa-robot mr-1"></i>Jana AI</span>
                    </label>
                    <textarea id="txt_obj" rows="3" class="w-full px-4 py-2 border rounded-lg" placeholder="1. ...&#10;2. ..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 flex justify-between items-center mb-1">
                        Aktiviti / Activities
                        <span class="text-xs text-blue-600 cursor-pointer bg-blue-100 px-2 py-1 rounded hover:bg-blue-200" onclick="openAIModal('akt')"><i class="fas fa-robot mr-1"></i>Jana AI (5E)</span>
                    </label>
                    <textarea id="txt_akt" rows="8" class="w-full px-4 py-2 border rounded-lg" placeholder="ENGAGE: ..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700">Pentaksiran / Assessment</label>
                    <textarea id="txt_pbd" rows="2" class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <label class="block text-sm font-bold text-gray-700">Refleksi / Reflection (Nota Peribadi)</label>
                    <p class="text-xs text-red-600 mb-2 font-bold">*Akan dikosongkan dalam PDF.</p>
                    <textarea id="txt_ref" rows="2" class="w-full px-4 py-2 border rounded-lg" placeholder="Tulis untuk rujukan."></textarea>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end border-t">
                <button id="btnGenerate" onclick="prepareAndPrint()" class="bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:scale-105 transition">JANA PDF</button>
            </div>
        </div>
        <p class="text-center text-gray-500 text-sm mt-6 mb-10 font-medium">2026 created by Cikgu Shairazi</p>
    </main>

    <!-- AI Modal -->
    <button id="floating-ai-btn" onclick="openAIModal('all')" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 rounded-full shadow-2xl flex items-center justify-center group"><i class="fas fa-robot text-2xl"></i></button>
    <div id="ai-overlay" onclick="closeAIModal()"></div>
    <div id="ai-modal">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-4 rounded-t-lg"><h3 class="text-white font-bold text-lg flex items-center"><i class="fas fa-brain mr-2"></i> Pembantu AI</h3></div>
        <div class="p-6">
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-600 mb-1">API Key OpenAI</label>
                <input type="password" id="api_key" class="w-full px-3 py-2 border rounded text-sm" placeholder="sk-..." onchange="saveApiKey()">
            </div>
            <div id="ai-status" class="hidden bg-blue-50 text-blue-800 p-3 rounded mb-4 text-sm flex items-center"><i class="fas fa-circle-notch fa-spin mr-2"></i> Sedang berfikir...</div>
            <div class="space-y-2">
                <button onclick="generateContent('obj')" class="w-full bg-green-100 text-green-800 py-2 rounded text-sm font-semibold border border-green-300">1. Objektif (Nombor)</button>
                <button onclick="generateContent('akt')" class="w-full bg-yellow-100 text-yellow-800 py-2 rounded text-sm font-semibold border border-yellow-300">2. Aktiviti (5E)</button>
                <button onclick="generateContent('all')" class="w-full bg-purple-600 text-white py-2 rounded text-sm font-semibold shadow-lg">3. Semua Sekaligus</button>
            </div>
            <div class="mt-4 pt-4 border-t flex justify-end"><button onclick="closeAIModal()" class="text-gray-500 hover:text-gray-700 text-sm">Tutup</button></div>
        </div>
    </div>

    <!-- PDF Template -->
    <div id="pdf-preview-section">
        <div class="flex items-center justify-center border-b-2 border-black pb-3 mb-4">
            <div style="width: 15%; display: flex; justify-content: center;"><img src="https://i.postimg.cc/15tfw5q1/logo-kedit.avif" alt="Logo" style="width: 70px; height: auto;" crossorigin="anonymous"></div>
            <div style="width: 85%; text-align: center;">
                <h1 class="text-xl font-bold uppercase tracking-wider" style="font-family: 'Times New Roman';">RANCANGAN PENGAJARAN HARIAN</h1>
                <h2 class="text-lg font-bold uppercase" style="font-family: 'Times New Roman';">SMK DATUK PATINGGI KEDIT</h2>
            </div>
        </div>
        <table class="official-table">
            <tr><td class="bg-gray-official" id="lbl_subject">Mata Pelajaran</td><td style="width: 35%;" id="out_subject"></td><td class="bg-gray-official" id="lbl_kelas">Kelas</td><td style="width: 35%;" id="out_kelas"></td></tr>
            <tr><td class="bg-gray-official" id="lbl_tarikh">Tarikh</td><td id="out_tarikh"></td><td class="bg-gray-official" id="lbl_masa">Masa</td><td id="out_masa"></td></tr>
            <tr><td class="bg-gray-official" colspan="4" id="lbl_bab">Bab / Topik</td></tr><tr><td colspan="4" id="out_bab" style="font-weight: bold;"></td></tr>
            <tr><td class="bg-gray-official" colspan="4" id="lbl_sk">Standard Kandungan</td></tr><tr><td colspan="4" id="out_sk"></td></tr>
            <tr><td class="bg-gray-official" colspan="4" id="lbl_sp">Standard Pembelajaran</td></tr><tr><td colspan="4" id="out_sp" class="text-content"></td></tr>
            <tr><td class="bg-gray-official" colspan="4" id="lbl_obj">Objektif Pembelajaran</td></tr><tr><td colspan="4" id="out_obj" class="text-content"></td></tr>
            <tr><td class="bg-gray-official" colspan="4" id="lbl_akt">Aktiviti PdPc</td></tr><tr><td colspan="4" id="out_akt" class="text-content"></td></tr>
            <tr><td class="bg-gray-official" colspan="4" id="lbl_pbd">Pentaksiran / PBD</td></tr><tr><td colspan="4" id="out_pbd" class="text-content"></td></tr>
            <tr><td class="bg-gray-official" colspan="4" id="lbl_ref">Refleksi</td></tr>
            <tr><td colspan="4" style="height: 100px; vertical-align: top;"><div class="refleksi-line"></div><div class="refleksi-line"></div><div class="refleksi-line"></div></td></tr>
        </table>
    </div>

    <!-- Logic -->
    <script>
        const labels = {
            "ms": { subject: "Mata Pelajaran", kelas: "Kelas", tarikh: "Tarikh", masa: "Masa", bab: "Bab / Topik", sk: "Standard Kandungan", sp: "Standard Pembelajaran", obj: "Objektif Pembelajaran", akt: "Aktiviti PdPc", pbd: "Pentaksiran / PBD", ref: "Refleksi" },
            "en": { subject: "Subject", kelas: "Class", tarikh: "Date", masa: "Time", bab: "Theme / Topic", sk: "Content Standard", sp: "Learning Standard", obj: "Learning Objectives", akt: "Activities", pbd: "Assessment / PBD", ref: "Reflection" }
        };

        document.getElementById('api_key').value = localStorage.getItem('openai_key') || '';
        function saveApiKey() { localStorage.setItem('openai_key', document.getElementById('api_key').value); }
        function openAIModal(type) { document.getElementById('ai-overlay').style.display = 'block'; document.getElementById('ai-modal').style.display = 'block'; }
        function closeAIModal() { document.getElementById('ai-overlay').style.display = 'none'; document.getElementById('ai-modal').style.display = 'none'; }

        async function generateContent(type) {
            const apiKey = document.getElementById('api_key').value;
            if(!apiKey) { alert("Sila masukkan API Key."); return; }
            const tingkatan = document.getElementById('sel_tingkatan').value;
            const sk = document.getElementById('txt_sk').value;
            const sp = document.getElementById('txt_sp').value;
            if(!sk || !sp) { alert("Pilih SK dan SP dahulu."); return; }
            document.getElementById('ai-status').classList.remove('hidden');

            const isDLP = tingkatan.includes("DLP");
            const langPrompt = isDLP ? "Output MUST be in ENGLISH." : "Output dalam Bahasa Melayu.";
            let userPrompt = `Class: ${tingkatan}. SK: ${sk}. SP: ${sp}. ${langPrompt}`;
            
            if (type === 'obj') userPrompt += ` Provide 2 numbered SMART learning objectives. Format: 1. ... 2. ...`;
            else if (type === 'akt') userPrompt += ` Provide 5E activities (Engage, Explore, Explain, Elaborate, Evaluate) with bullets.`;
            else userPrompt += ` Provide 2 numbered objectives AND 5E activities. Separate with [SPLIT].`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "gpt-3.5-turbo", messages: [{role: "user", content: userPrompt}], temperature: 0.7 })
                });
                const data = await response.json();
                const result = data.choices[0].message.content;

                if(type === 'obj') document.getElementById('txt_obj').value = result;
                else if(type === 'akt') document.getElementById('txt_akt').value = result;
                else {
                    const parts = result.split("[SPLIT]");
                    if(parts.length > 1) { document.getElementById('txt_obj').value = parts[0]; document.getElementById('txt_akt').value = parts[1]; }
                    else document.getElementById('txt_akt').value = result;
                }
                closeAIModal();
            } catch (err) { alert("Error AI: " + err.message); } 
            finally { document.getElementById('ai-status').classList.add('hidden'); }
        }

        // Functions using MASTER_DATA from data.js
        function updateBab() {
            const t = document.getElementById("sel_tingkatan").value;
            const b = document.getElementById("sel_bab");
            const s = document.getElementById("sel_sk");
            const p = document.getElementById("sel_sp");
            
            b.innerHTML = '<option value="">-- Select --</option>'; s.innerHTML = '<option value="">-- Select --</option>'; p.innerHTML = '<option value="">-- Select --</option>';
            b.disabled = false; s.disabled = true; p.disabled = true;
            document.getElementById("txt_sk").value = ""; document.getElementById("txt_sp").value = "";

            if(t && typeof MASTER_DATA !== 'undefined' && MASTER_DATA[t]) {
                for(let k in MASTER_DATA[t]) { let opt = document.createElement("option"); opt.value = k; opt.text = k; b.add(opt); }
            }
        }
        function updateSK() {
            const t = document.getElementById("sel_tingkatan").value;
            const b = document.getElementById("sel_bab").value;
            const s = document.getElementById("sel_sk");
            s.innerHTML = '<option value="">-- Select --</option>';
            if(b && MASTER_DATA[t][b]) {
                s.disabled = false;
                for(let k in MASTER_DATA[t][b]) { let opt = document.createElement("option"); opt.value = k; opt.text = k; s.add(opt); }
            }
        }
        function updateSP() {
            const t = document.getElementById("sel_tingkatan").value;
            const b = document.getElementById("sel_bab").value;
            const s = document.getElementById("sel_sk").value;
            const p = document.getElementById("sel_sp");
            p.innerHTML = '<option value="">-- Add SP --</option>';
            document.getElementById("txt_sk").value = s; document.getElementById("txt_sp").value = "";
            if(s && MASTER_DATA[t][b][s]) {
                p.disabled = false;
                MASTER_DATA[t][b][s].forEach(item => {
                    let opt = document.createElement("option"); opt.value = item;
                    opt.text = item.length > 80 ? item.substring(0,80)+"..." : item;
                    opt.setAttribute('data-full', item); p.add(opt);
                });
            }
        }
        function addSP() {
            const p = document.getElementById("sel_sp");
            const txt = document.getElementById("txt_sp");
            const val = p.options[p.selectedIndex].getAttribute('data-full');
            if(val) {
                if(txt.value === "") txt.value = val;
                else if(!txt.value.includes(val)) txt.value += "\n" + val;
                p.selectedIndex = 0;
            }
        }
        function prepareAndPrint() {
            window.scrollTo(0,0); transferData();
            document.body.classList.add('generating-mode');
            setTimeout(() => {
                const element = document.getElementById('pdf-preview-section');
                const kelas = document.getElementById('inp_kelas').value || 'Kelas';
                const tarikh = document.getElementById('inp_tarikh').value || 'Tarikh';
                const opt = { margin: 0, filename: `RPH_${kelas.replace(/\s/g,'_')}_${tarikh}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                html2pdf().set(opt).from(element).save().then(() => { document.body.classList.remove('generating-mode'); });
            }, 500);
        }
        function transferData() {
            const tingkatan = document.getElementById("sel_tingkatan").value;
            const isDLP = tingkatan.includes("DLP");
            const lang = isDLP ? labels.en : labels.ms;
            document.getElementById("lbl_subject").innerText = lang.subject; document.getElementById("lbl_kelas").innerText = lang.kelas;
            document.getElementById("lbl_tarikh").innerText = lang.tarikh; document.getElementById("lbl_masa").innerText = lang.masa;
            document.getElementById("lbl_bab").innerText = lang.bab; document.getElementById("lbl_sk").innerText = lang.sk;
            document.getElementById("lbl_sp").innerText = lang.sp; document.getElementById("lbl_obj").innerText = lang.obj;
            document.getElementById("lbl_akt").innerText = lang.akt; document.getElementById("lbl_pbd").innerText = lang.pbd;
            document.getElementById("lbl_ref").innerText = lang.ref;

            const getVal = (id) => document.getElementById(id).value || '-';
            const rawDate = document.getElementById('inp_tarikh').value;
            let dateStr = '-';
            if (rawDate) { const d = new Date(rawDate); dateStr = d.toLocaleDateString(isDLP ? 'en-GB' : 'ms-MY', {day: '2-digit', month: '2-digit', year: 'numeric'}); }
            document.getElementById('out_subject').innerText = getVal('inp_subject'); document.getElementById('out_kelas').innerText = getVal('inp_kelas');
            document.getElementById('out_tarikh').innerText = dateStr; document.getElementById('out_masa').innerText = getVal('inp_masa');
            document.getElementById('out_bab').innerText = getVal('sel_bab'); document.getElementById('out_sk').innerText = getVal('txt_sk');
            document.getElementById('out_sp').innerText = getVal('txt_sp'); document.getElementById('out_obj').innerText = getVal('txt_obj');
            document.getElementById('out_akt').innerText = getVal('txt_akt'); document.getElementById('out_pbd').innerText = getVal('txt_pbd');
        }
    </script>
</body>
</html>
